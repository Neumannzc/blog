---
title: æ³¨è§£-spring bootä¸­çš„æ ¡éªŒæ³¨è§£
date: 2024-05-07
icon: dragon
category:
  - åç«¯
tag:
  - æ³¨è§£
order: 330
---

åœ¨ Spring Boot ä¸­ï¼Œ@Validated æ˜¯ç”¨äºè§¦å‘å‚æ•°æ ¡éªŒçš„æ³¨è§£ï¼Œé€šå¸¸ä¸ â€‹â€‹JSR-303/JSR-380â€‹â€‹ï¼ˆBean Validationï¼‰æä¾›çš„æ ¡éªŒæ³¨è§£ä¸€èµ·ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„æ ¡éªŒæ³¨è§£åŠå…¶ç”¨æ³•ï¼š

<!-- more -->
## â€‹1. åŸºæœ¬æ ¡éªŒæ³¨è§£â€‹â€‹

è¿™äº›æ³¨è§£å¯ä»¥ç›´æ¥ç”¨äºå­—æ®µã€æ–¹æ³•å‚æ•°æˆ–æ–¹æ³•è¿”å›å€¼ï¼Œç»“åˆ @Validated è¿›è¡Œæ ¡éªŒã€‚
æ³¨è§£	| ä½œç”¨	| ç¤ºä¾‹
-- | -- | --
@NotNull	| ä¸èƒ½ä¸º null	| @NotNull(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
@NotEmpty	| ä¸èƒ½ä¸º null ä¸”ä¸èƒ½ä¸ºç©ºï¼ˆé€‚ç”¨äº Stringã€Collectionã€Mapã€Arrayï¼‰	| @NotEmpty(message = "åˆ—è¡¨ä¸èƒ½ä¸ºç©º")
@NotBlank	| ä¸èƒ½ä¸º null ä¸” trim() åé•¿åº¦ > 0ï¼ˆä»…é€‚ç”¨äº Stringï¼‰	| @NotBlank(message = "å§“åä¸èƒ½ä¸ºç©º")
@Null	| å¿…é¡»ä¸º null	| @Null(message = "ID ä¸èƒ½å­˜åœ¨")
@AssertTrue	| å¿…é¡»ä¸º true	| @AssertTrue(message = "å¿…é¡»åŒæ„åè®®")
@AssertFalse	| å¿…é¡»ä¸º false	| @AssertFalse(message = "ä¸èƒ½å¯ç”¨")
@Past	| å¿…é¡»æ˜¯è¿‡å»çš„æ—¶é—´ï¼ˆDateã€LocalDateTime ç­‰ï¼‰	| @Past(message = "å‡ºç”Ÿæ—¥æœŸå¿…é¡»æ˜¯è¿‡å»")
@Future	| å¿…é¡»æ˜¯æœªæ¥çš„æ—¶é—´	| @Future(message = "æˆªæ­¢æ—¶é—´å¿…é¡»æ˜¯æœªæ¥")
@Pattern(regex)	| å¿…é¡»åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼	| @Pattern(regexp = "^[a-zA-Z0-9]+$", message = "åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—")
@Size(min, max)	| å­—ç¬¦ä¸²/é›†åˆ/æ•°ç»„çš„é•¿åº¦èŒƒå›´	| @Size(min = 2, max = 10, message = "é•¿åº¦å¿…é¡»åœ¨ 2-10 ä¹‹é—´")
@Length(min, max)	| ï¼ˆHibernate Validator æ‰©å±•ï¼‰åŒ @Size	| @Length(min = 2, max = 10)
@Min(value)	| æœ€å°å€¼ï¼ˆé€‚ç”¨äº Numberï¼‰	| @Min(1, message = "å¹´é¾„ä¸èƒ½å°äº 1")
@Max(value)	| æœ€å¤§å€¼ï¼ˆé€‚ç”¨äº Numberï¼‰	| @Max(120, message = "å¹´é¾„ä¸èƒ½è¶…è¿‡ 120")
@DecimalMin(value)	| æœ€å°å€¼ï¼ˆé€‚ç”¨äº BigDecimalï¼‰	| @DecimalMin("0.01", message = "é‡‘é¢ä¸èƒ½å°äº 0.01")
@DecimalMax(value)	| æœ€å¤§å€¼ï¼ˆé€‚ç”¨äº BigDecimalï¼‰	| @DecimalMax("999999.99")
@Digits(integer, fraction)	| æ•°å­—ç²¾åº¦ï¼ˆæ•´æ•°ä½å’Œå°æ•°ä½ï¼‰	| @Digits(integer = 5, fraction = 2, message = "æœ€å¤š 5 ä½æ•´æ•°ï¼Œ2 ä½å°æ•°")
@Email	| å¿…é¡»æ˜¯æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼	| @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")

## â€‹â€‹2. åˆ†ç»„æ ¡éªŒï¼ˆgroupsï¼‰â€‹â€‹

å¯ä»¥å®šä¹‰ä¸åŒçš„æ ¡éªŒè§„åˆ™ï¼Œå¹¶åœ¨ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨ï¼š

```java
public class User {
    @NotNull(groups = {Create.class, Update.class}, message = "ID ä¸èƒ½ä¸ºç©º")
    @Null(groups = {Delete.class}, message = "åˆ é™¤æ—¶ä¸èƒ½ä¼  ID")
    private Long id;

    @NotBlank(groups = Create.class, message = "åˆ›å»ºæ—¶ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String username;

    public interface Create {}
    public interface Update {}
    public interface Delete {}
}
```

**â€‹â€‹Controller ä½¿ç”¨åˆ†ç»„æ ¡éªŒâ€‹â€‹ï¼š**
```java
@PostMapping("/create")
public String create(@Validated(User.Create.class) @RequestBody User user) {
    // åªæ ¡éªŒ Create åˆ†ç»„çš„è§„åˆ™
    return "Created";
}

@PutMapping("/update")
public String update(@Validated(User.Update.class) @RequestBody User user) {
    // åªæ ¡éªŒ Update åˆ†ç»„çš„è§„åˆ™
    return "Updated";
}
```

## â€‹â€‹3. åµŒå¥—å¯¹è±¡æ ¡éªŒï¼ˆ@Validï¼‰â€‹â€‹

å¦‚æœå¯¹è±¡åŒ…å«åµŒå¥—å¯¹è±¡ï¼Œéœ€è¦ç”¨ @Valid è§¦å‘åµŒå¥—æ ¡éªŒï¼š

```java
public class Order {
    @NotNull
    private Long id;

    @Valid  // è§¦å‘åµŒå¥—æ ¡éªŒ
    @NotNull
    private User user;  // User ç±»ä¹Ÿéœ€è¦æ ¡éªŒæ³¨è§£
}
```

**â€‹â€‹Controller ä½¿ç”¨â€‹â€‹ï¼š**

```java
@PostMapping("/order")
public String createOrder(@Validated @RequestBody Order order) {
    // ä¼šæ ¡éªŒ Order å’Œ User çš„æ‰€æœ‰æ ¡éªŒè§„åˆ™
    return "Order created";
}
```

## â€‹â€‹4. è‡ªå®šä¹‰æ ¡éªŒæ³¨è§£â€‹â€‹

å¦‚æœå†…ç½®æ³¨è§£ä¸æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥è‡ªå®šä¹‰æ ¡éªŒæ³¨è§£ï¼š
â€‹â€‹ç¤ºä¾‹ï¼šæ ¡éªŒ Integer æ˜¯å¦æ˜¯ 0 æˆ– 1â€‹â€‹

### 1. å®šä¹‰æ³¨è§£ @OneOrZeroâ€‹â€‹

```java
import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.*;

@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = OneOrZeroValidator.class)
public @interface OneOrZero {
    String message() default "å€¼å¿…é¡»æ˜¯ 0 æˆ– 1";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```

### 2. å®ç°æ ¡éªŒé€»è¾‘ OneOrZeroValidatorâ€‹â€‹

```java
import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;

public class OneOrZeroValidator implements ConstraintValidator<OneOrZero, Integer> {
    @Override
    public boolean isValid(Integer value, ConstraintValidatorContext context) {
        return value == null || (value == 0 || value == 1);
    }
}
```

### â€‹â€‹3. åœ¨å®ä½“ç±»ä¸­ä½¿ç”¨â€‹â€‹

```java
public class MyRequest {
    @OneOrZero(message = "çŠ¶æ€å¿…é¡»æ˜¯ 0 æˆ– 1")
    private Integer status;
}
```

## â€‹â€‹5. å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆ@ControllerAdviceï¼‰â€‹â€‹

å½“æ ¡éªŒå¤±è´¥æ—¶ï¼ŒSpring ä¼šæŠ›å‡º MethodArgumentNotValidExceptionï¼Œå¯ä»¥é€šè¿‡ @ControllerAdvice ç»Ÿä¸€å¤„ç†ï¼š

```java
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String, String>> handleValidationExceptions(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error -> 
            errors.put(error.getField(), error.getDefaultMessage())
        );
        return new ResponseEntity<>(errors, HttpStatus.BAD_REQUEST);
    }
}
```

â€‹â€‹è¿”å›ç¤ºä¾‹â€‹â€‹ï¼š

```json
{
    "username": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
    "email": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
}
```

## â€‹â€‹6. å¸¸è§é—®é¢˜â€‹â€‹

**â€‹â€‹Q1: @Valid å’Œ @Validated çš„åŒºåˆ«ï¼Ÿâ€‹â€‹**
æ³¨è§£	| ä½œç”¨	| é€‚ç”¨åœºæ™¯
-- | -- | --
@Valid	| è§¦å‘ JSR-303 æ ¡éªŒ	| ä¸€èˆ¬ç”¨äºåµŒå¥—å¯¹è±¡æ ¡éªŒï¼ˆå¦‚ @Valid User userï¼‰
@Validated	| Spring æä¾›çš„å¢å¼ºç‰ˆï¼Œæ”¯æŒåˆ†ç»„æ ¡éªŒ	| ä¸€èˆ¬ç”¨äº Controller æ–¹æ³•å‚æ•°æ ¡éªŒ

**â€‹â€‹Q2: ä¸ºä»€ä¹ˆ @Validated ä¸ç”Ÿæ•ˆï¼Ÿâ€‹â€‹**

- æ£€æŸ¥æ˜¯å¦åœ¨ â€‹â€‹Controller ç±»æˆ–æ–¹æ³•å‚æ•°â€‹â€‹ ä¸Šä½¿ç”¨äº† @Validatedã€‚
- ç¡®ä¿ä¾èµ–æ­£ç¡®ï¼ˆSpring Boot é»˜è®¤åŒ…å« spring-boot-starter-validationï¼‰ã€‚
- å¦‚æœæ ¡éªŒçš„æ˜¯ List æˆ– Mapï¼Œç¡®ä¿ä½¿ç”¨ @Valid åµŒå¥—æ ¡éªŒï¼š

```java
    public class Request {
        @Valid  // å¿…é¡»åŠ  @Valid
        private List<User> users;
    }
```

## 7. â€‹â€‹æ€»ç»“â€‹â€‹
åœºæ™¯	| æ¨èæ³¨è§£
-- | --
åŸºæœ¬æ ¡éªŒ	| @NotNull, @NotEmpty, @Pattern, @Size
åˆ†ç»„æ ¡éªŒ	| groups + @Validated
åµŒå¥—æ ¡éªŒ	| @Valid
è‡ªå®šä¹‰æ ¡éªŒ	| @Constraint + ConstraintValidator
å…¨å±€å¼‚å¸¸å¤„ç†	| @ControllerAdvice

**é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›æ³¨è§£ï¼Œå¯ä»¥è½»æ¾å®ç°å‚æ•°æ ¡éªŒï¼Œæé«˜ä»£ç å¥å£®æ€§ï¼ ğŸš€**