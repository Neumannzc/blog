import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as t,d as e,o as p}from"./app-BseF94sA.js";const c={};function o(l,n){return p(),a("div",null,[t(" more "),n[0]||(n[0]=e(`<h2 id="​1-为什么要用-redis" tabindex="-1"><a class="header-anchor" href="#​1-为什么要用-redis"><span>​1 为什么要用 Redis</span></a></h2><ul><li><p>​高性能：基于内存的数据结构，支持高并发读写（单线程模型）。</p></li><li><p>​持久化：支持 RDB/AOF 持久化机制，避免数据丢失。</p></li><li><p>​分布式支持：天然支持分布式环境，适合微服务架构。</p></li><li><p>​丰富的数据结构：支持 String、Hash、List、Set 等数据类型，满足复杂业务场景。</p></li></ul><h2 id="​2-为什么要用-spring-cache" tabindex="-1"><a class="header-anchor" href="#​2-为什么要用-spring-cache"><span>​2 为什么要用 Spring Cache</span></a></h2><ul><li><p>​简化缓存逻辑：Spring Cache 提供统一的注解（如 @Cacheable, @CacheEvict），无需手动管理缓存操作。</p></li><li><p>​支持多缓存实现：可无缝集成 Redis、Ehcache、Caffeine 等缓存工具，通过配置切换底层缓存。</p></li><li><p>​声明式编程：开发者只需关注业务逻辑，无需关心缓存的底层实现细节。</p></li></ul><h2 id="_3-​spring-cache-redis-的典型使用场景" tabindex="-1"><a class="header-anchor" href="#_3-​spring-cache-redis-的典型使用场景"><span>3 ​Spring Cache + Redis 的典型使用场景</span></a></h2><ul><li><p>​高频数据访问：如用户信息、商品详情等静态数据的缓存。</p></li><li><p>​热点数据隔离：秒杀场景下的库存、优惠券等热点资源防击穿。</p></li><li><p>​分布式锁：利用 Redis 的原子操作实现分布式锁（如 Redisson）。</p></li><li><p>​会话共享：在无状态服务中集中管理用户 Session。</p></li></ul><h2 id="_4-​spring-cache-redis-的使用" tabindex="-1"><a class="header-anchor" href="#_4-​spring-cache-redis-的使用"><span>4 ​Spring Cache + Redis 的使用</span></a></h2><h3 id="_4-​1-添加依赖" tabindex="-1"><a class="header-anchor" href="#_4-​1-添加依赖"><span>4.​1 添加依赖</span></a></h3><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- Spring Boot Starter Cache --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Spring Boot Starter Data Redis --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-​2-启用缓存支持" tabindex="-1"><a class="header-anchor" href="#_4-​2-启用缓存支持"><span>4.​2 启用缓存支持</span></a></h3><ul><li>在 Spring Boot 主类上添加 @EnableCaching 注解：</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-​3-配置-redis" tabindex="-1"><a class="header-anchor" href="#_4-​3-配置-redis"><span>4.​3 配置 Redis</span></a></h3><ul><li>在 application.properties 中配置 Redis 连接：</li></ul><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token key attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token value attr-value">localhost</span>
<span class="token key attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>
<span class="token key attr-name">spring.redis.password</span><span class="token punctuation">=</span>
<span class="token key attr-name">spring.redis.database</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token key attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token value attr-value">redis # 明确指定使用 Redis 作为缓存</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-​4-使用缓存注解" tabindex="-1"><a class="header-anchor" href="#_4-​4-使用缓存注解"><span>4.​4 使用缓存注解</span></a></h3><h4 id="_4-4-1-查询缓存-cacheable-​" tabindex="-1"><a class="header-anchor" href="#_4-4-1-查询缓存-cacheable-​"><span>4.4.1 查询缓存（@Cacheable）​</span></a></h4><p>用于标记方法的返回值应该被缓存。当方法被调用时，Spring Cache 会首先检查缓存中是否存在对应的数据，如果存在则直接返回缓存数据，否则执行方法并将结果缓存起来。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 模拟从数据库查询</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>value：缓存名称空间（如 &quot;users&quot;）。</p></li><li><p>key：缓存键，可以使用 SpEL 表达式</p></li><li><p>tips: 当参数id可能为空时，需要添加为空的默认值 <code>@Cacheable(value = &quot;users&quot;, key = &quot;#id ?: &#39;defaultKey&#39;&quot;)</code></p></li></ul><h4 id="_4-4-2-更新缓存-cacheput-​" tabindex="-1"><a class="header-anchor" href="#_4-4-2-更新缓存-cacheput-​"><span>4.4.2 更新缓存（@CachePut）​</span></a></h4><p>用于更新缓存，无论缓存是否存在，都会执行方法并将结果存入缓存。常用于更新操作后刷新缓存。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#user.id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>直接更新缓存，不依赖旧值。</li></ul><h4 id="_4-4-3-删除缓存-cacheevict-​" tabindex="-1"><a class="header-anchor" href="#_4-4-3-删除缓存-cacheevict-​"><span>4.4.3 删除缓存（@CacheEvict）​</span></a></h4><p>用于清除缓存，常用于删除操作后移除对应的缓存数据。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-4-批量操作" tabindex="-1"><a class="header-anchor" href="#_4-4-4-批量操作"><span>4.4.4 批量操作</span></a></h4><p>用于组合多个缓存操作，可以在一个方法上同时使用 <code>@Cacheable</code>、<code>@CachePut</code> 和 <code>@CacheEvict</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Caching</span><span class="token punctuation">(</span>
    cacheable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    evict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span><span class="token string">&quot;logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 业务逻辑...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="​5-自定义缓存-key-和-ttl" tabindex="-1"><a class="header-anchor" href="#​5-自定义缓存-key-和-ttl"><span>​5 自定义缓存 Key 和 TTL</span></a></h2><h3 id="​5-1-​自定义-key-生成器" tabindex="-1"><a class="header-anchor" href="#​5-1-​自定义-key-生成器"><span>​5.1 ​自定义 Key 生成器</span></a></h3><ul><li>实现 KeyGenerator 接口：</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomKeyGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">KeyGenerator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> param <span class="token operator">:</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            key<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="​5-2-在缓存注解中引用" tabindex="-1"><a class="header-anchor" href="#​5-2-在缓存注解中引用"><span>​5.2 在缓存注解中引用：</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> keyGenerator <span class="token operator">=</span> <span class="token string">&quot;customKeyGenerator&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUserByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="​5-3-​设置缓存过期时间-ttl-​" tabindex="-1"><a class="header-anchor" href="#​5-3-​设置缓存过期时间-ttl-​"><span>​5.3 ​设置缓存过期时间（TTL）​</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">CacheManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableCaching</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">RedisCacheManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">RedisConnectionFactory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 明确配置 key 和 value 的序列化方式</span>
        <span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyPair <span class="token operator">=</span>
                <span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valuePair <span class="token operator">=</span>
                <span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 默认缓存配置，设置默认过期时间为10分钟</span>
        <span class="token class-name">RedisCacheConfiguration</span> defaultCacheConfig <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不缓存 null 值</span>
                <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span>keyPair<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>valuePair<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 为特定缓存名称设置不同的过期时间</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">&gt;</span></span> cacheConfigurations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cacheConfigurations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> defaultCacheConfig<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户缓存30分钟</span>
        cacheConfigurations<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;products&quot;</span><span class="token punctuation">,</span> defaultCacheConfig<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 产品缓存1小时</span>

        <span class="token keyword">return</span> <span class="token class-name">RedisCacheManager</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>defaultCacheConfig<span class="token punctuation">)</span> <span class="token comment">// 设置默认配置</span>
                <span class="token punctuation">.</span><span class="token function">withInitialCacheConfigurations</span><span class="token punctuation">(</span>cacheConfigurations<span class="token punctuation">)</span> <span class="token comment">// 为特定缓存设置配置</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>tips：需要明确明确配置 key 和 value 的序列化方式，否则会出现数据存储到redis中，但是在可视化工具中无法找到的问题</li></ul><h2 id="​6-实现原理" tabindex="-1"><a class="header-anchor" href="#​6-实现原理"><span>​6 实现原理</span></a></h2><ul><li><p>​Spring Cache 抽象层</p><ul><li>​<strong>CacheManager</strong>：管理所有缓存实例（如 RedisCacheManager）。</li><li>​<strong>Cache</strong>：定义缓存操作（如 get, put, evict）。</li><li>​<strong>CacheResolver</strong>：动态解析缓存名称和 Key。</li></ul></li><li><p>​Redis 缓存实现</p><ul><li>​<strong>RedisTemplate</strong>：Spring Data Redis 提供的模板类，封装了 Redis 原生操作。</li><li>​<strong>RedisCacheManager</strong>：自动将 Spring Cache 注解映射为 Redis 命令。</li></ul></li></ul><h2 id="​7-注意事项" tabindex="-1"><a class="header-anchor" href="#​7-注意事项"><span>​7 注意事项</span></a></h2><h3 id="_7-1-缓存穿透" tabindex="-1"><a class="header-anchor" href="#_7-1-缓存穿透"><span>7.1 缓存穿透</span></a></h3><ul><li>​问题：查询不存在的数据导致大量请求打到数据库。</li><li>​解决方案： <ul><li>使用布隆过滤器（Bloom Filter）过滤无效 Key。</li><li>在缓存中存储空值（@Cacheable 默认返回 null）。</li></ul></li></ul><h3 id="_7-2-缓存雪崩" tabindex="-1"><a class="header-anchor" href="#_7-2-缓存雪崩"><span>7.2 缓存雪崩</span></a></h3><ul><li>​问题：缓存 Key 过期时间集中失效，导致瞬时流量冲击。</li><li>​解决方案： <ul><li>随机化缓存 TTL（如 1-5 秒随机）。</li><li>使用 Redis 的 SCAN 代替 KEYS 命令遍历缓存。</li></ul></li></ul><h3 id="_7-3-缓存击穿" tabindex="-1"><a class="header-anchor" href="#_7-3-缓存击穿"><span>7.3 缓存击穿</span></a></h3><ul><li>​问题：热点 Key 被恶意用户反复请求，导致数据库压力过大。</li><li>​解决方案： <ul><li>使用互斥锁（Redisson 的 RLock）。</li><li>本地缓存 + 二次验证。</li></ul></li></ul><h2 id="​8-示例场景-商品库存服务" tabindex="-1"><a class="header-anchor" href="#​8-示例场景-商品库存服务"><span>​8 示例场景：商品库存服务</span></a></h2><ul><li>​业务需求 <ul><li>用户下单时减少商品库存，需保证库存扣减的原子性。</li></ul></li></ul><p>​实现代码</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;stocks&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#productId&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">decreaseStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用 Lua 脚本保证原子性</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call(&#39;get&#39;, KEYS[1]) &gt;= ARGV[1] then &quot;</span> <span class="token operator">+</span>
                       <span class="token string">&quot;   redis.call(&#39;decrby&#39;, KEYS[1], ARGV[1]) &quot;</span> <span class="token operator">+</span>
                       <span class="token string">&quot;   return 1 &quot;</span> <span class="token operator">+</span>
                       <span class="token string">&quot;else &quot;</span> <span class="token operator">+</span>
                       <span class="token string">&quot;   return 0 &quot;</span> <span class="token operator">+</span>
                       <span class="token string">&quot;end&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> redisScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
                redisScript<span class="token punctuation">.</span><span class="token function">setArgs</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> redisScript<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>​关键点：通过 Redis 的 Lua 脚本保证库存扣减的原子性，避免超卖。</li></ul><h2 id="_9-总结" tabindex="-1"><a class="header-anchor" href="#_9-总结"><span>9 总结</span></a></h2><ul><li>​Spring Cache：简化缓存操作，与业务解耦。</li><li>​Redis：提供高性能、高可用的分布式缓存支持。</li><li>​组合优势：适用于高并发、大数据量的场景，提升系统响应速度和稳定性</li></ul>`,55))])}const r=s(c,[["render",o],["__file","SpringCache.html.vue"]]),k=JSON.parse('{"path":"/posts/sql/redis/SpringCache.html","title":"Spring Cache","lang":"zh-CN","frontmatter":{"title":"Spring Cache","date":"2025-02-18T00:00:00.000Z","icon":"dragon","category":["redis"],"tag":["redis的使用"],"order":800,"head":[["meta",{"property":"og:url","content":"https://github.com/Neumannzc/blog/blog/posts/sql/redis/SpringCache.html"}],["meta",{"property":"og:site_name","content":"Cafe Babe"}],["meta",{"property":"og:title","content":"Spring Cache"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-06T03:32:11.000Z"}],["meta",{"property":"article:author","content":"Cafe Babe"}],["meta",{"property":"article:tag","content":"redis的使用"}],["meta",{"property":"article:published_time","content":"2025-02-18T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-06T03:32:11.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Spring Cache\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-02-18T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-06T03:32:11.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Cafe Babe\\",\\"url\\":\\"https://gitee.com/z517890027\\"}]}"]]},"headers":[{"level":2,"title":"​1 为什么要用 Redis","slug":"​1-为什么要用-redis","link":"#​1-为什么要用-redis","children":[]},{"level":2,"title":"​2 为什么要用 Spring Cache","slug":"​2-为什么要用-spring-cache","link":"#​2-为什么要用-spring-cache","children":[]},{"level":2,"title":"3 ​Spring Cache + Redis 的典型使用场景","slug":"_3-​spring-cache-redis-的典型使用场景","link":"#_3-​spring-cache-redis-的典型使用场景","children":[]},{"level":2,"title":"4 ​Spring Cache + Redis 的使用","slug":"_4-​spring-cache-redis-的使用","link":"#_4-​spring-cache-redis-的使用","children":[{"level":3,"title":"4.​1 添加依赖","slug":"_4-​1-添加依赖","link":"#_4-​1-添加依赖","children":[]},{"level":3,"title":"4.​2 启用缓存支持","slug":"_4-​2-启用缓存支持","link":"#_4-​2-启用缓存支持","children":[]},{"level":3,"title":"4.​3 配置 Redis","slug":"_4-​3-配置-redis","link":"#_4-​3-配置-redis","children":[]},{"level":3,"title":"4.​4 使用缓存注解","slug":"_4-​4-使用缓存注解","link":"#_4-​4-使用缓存注解","children":[]}]},{"level":2,"title":"​5 自定义缓存 Key 和 TTL","slug":"​5-自定义缓存-key-和-ttl","link":"#​5-自定义缓存-key-和-ttl","children":[{"level":3,"title":"​5.1 ​自定义 Key 生成器","slug":"​5-1-​自定义-key-生成器","link":"#​5-1-​自定义-key-生成器","children":[]},{"level":3,"title":"​5.2 在缓存注解中引用：","slug":"​5-2-在缓存注解中引用","link":"#​5-2-在缓存注解中引用","children":[]},{"level":3,"title":"​5.3 ​设置缓存过期时间（TTL）​","slug":"​5-3-​设置缓存过期时间-ttl-​","link":"#​5-3-​设置缓存过期时间-ttl-​","children":[]}]},{"level":2,"title":"​6 实现原理","slug":"​6-实现原理","link":"#​6-实现原理","children":[]},{"level":2,"title":"​7 注意事项","slug":"​7-注意事项","link":"#​7-注意事项","children":[{"level":3,"title":"7.1 缓存穿透","slug":"_7-1-缓存穿透","link":"#_7-1-缓存穿透","children":[]},{"level":3,"title":"7.2 缓存雪崩","slug":"_7-2-缓存雪崩","link":"#_7-2-缓存雪崩","children":[]},{"level":3,"title":"7.3 缓存击穿","slug":"_7-3-缓存击穿","link":"#_7-3-缓存击穿","children":[]}]},{"level":2,"title":"​8 示例场景：商品库存服务","slug":"​8-示例场景-商品库存服务","link":"#​8-示例场景-商品库存服务","children":[]},{"level":2,"title":"9 总结","slug":"_9-总结","link":"#_9-总结","children":[]}],"git":{"createdTime":1740662511000,"updatedTime":1746502331000,"contributors":[{"name":"Cafe Babe","email":"517890027@qq.com","commits":2}]},"readingTime":{"minutes":5.03,"words":1508},"filePathRelative":"posts/sql/redis/SpringCache.md","localizedDate":"2025年2月18日","excerpt":""}');export{r as comp,k as data};
